<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumiére - Painel administrativo</title>
    <link rel="stylesheet" href="assets/css/painel_administrativo.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@1,700&display=swap"
        rel="stylesheet">

    <script src="assets/js/seguranca.js" defer></script>

    <style>
        .filtro-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filtro-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filtro-group label {
            font-weight: bold;
            color: #8B0000;
            font-size: 14px;
        }

        .filtro-group input {
            padding: 10px;
            border: 2px solid #8B0000;
            border-radius: 5px;
            font-size: 14px;
            min-width: 150px;
        }

        .btn-filtrar {
            background: #8B0000;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn-filtrar:hover {
            background: #A00000;
        }

        .botao-relatorio {
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .botao-relatorio:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .botao-relatorio:active {
            transform: translateY(0);
        }

        .botao-relatorio:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <img src="assets/img/fundo.vermelho.png" alt="" class="background">
    <header>
        <img src="assets/img/logo.png" alt="LUMIÉRE - Beleza | Estética | Bem-estar" class="logo">
        <nav>
            <a class="btn-logout" style="cursor: pointer;">LOGOUT</a>
            <a href="edicao_dados.html">EDIÇÃO DE DADOS</a>
            <a href="cadastroservico.html">CADASTRAR SERVIÇOS</a>
            <a href="index.cadastroservico.html">CADASTRAR AGENDAMENTO</a>
            <a href="painel_profissional.html">PAINEL PROFISSIONAL</a>
            <a href="painel_administrativo.html">PAINEL ADMINISTRATIVO</a>
            <a href="listagem.html">LISTAGEM</a>
        </nav>
    </header>

    <main>
        <h1 class="titulo">Painel Administrativo</h1>

        <div class="filtro-container">
            <form class="filtro-form" id="filtroForm">
                <div class="filtro-group">
                    <label for="dataInicial">Data Inicial:</label>
                    <input type="date" id="dataInicial" name="dataInicial" required>
                </div>
                <div class="filtro-group">
                    <label for="dataFinal">Data Final:</label>
                    <input type="date" id="dataFinal" name="dataFinal" required>
                </div>
                <button type="submit" class="btn-filtrar">FILTRAR</button>
            </form>
        </div>

        <div class="painel-glitter">
            <img src="assets/img/fundo_cadastroservico.png" alt="background de glitter" class="img-glitter">

            <div class="cards-container">
                <div class="card">
                    <h2>NÚMERO DE AGENDAMENTOS</h2>
                    <p class="valor" id="numAgendamentos">0</p>
                    <button type="button" class="botao-relatorio" data-tipo="agendamentos">
                        GERAR RELATÓRIO
                        <img src="assets/img/baixar.png" alt="Baixar">
                    </button>
                </div>

                <div class="card">
                    <h2>FATURAMENTO</h2>
                    <p class="valor" id="faturamento">R$ 0,00</p>
                    <button type="button" class="botao-relatorio" data-tipo="faturamento">
                        GERAR RELATÓRIO
                        <img src="assets/img/baixar.png" alt="Baixar">
                    </button>
                </div>

                <div class="card">
                    <h2>QUANTIDADE DE CLIENTES</h2>
                    <p class="valor" id="qtdClientes">0</p>
                    <button type="button" class="botao-relatorio" data-tipo="clientes">
                        GERAR RELATÓRIO
                        <img src="assets/img/baixar.png" alt="Baixar">
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer1">
            <div class="footer-left">
                <div class="contact">
                    <img src="assets/img/celular.icon.png" alt="Telefone" class="icon">
                    <span>(18)000000000</span>
                </div>
                <div class="contact">
                    <img src="assets/img/location-icon.png" alt="Localização" class="icon">
                    <span>Avenida das flores</span>
                </div>
            </div>

            <div class="footer-center">
                <img src="assets/img/logo.png" alt="Logo Lumiére" class="logorodape">
            </div>
        </div>

        <div class="footer-bottom">
            <span>© 2025. Todos os direitos reservados.</span>
        </div>
    </footer>

    <script>
        const API_URL = 'http://10.92.3.171:5000';

        function getToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        function setDataHoje() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicial').value = hoje;
            document.getElementById('dataFinal').value = hoje;
        }

        async function carregarDadosPainel(dataInicial, dataFinal) {
            try {
                const token = getToken();

                if (!token) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sessão expirada',
                        text: 'Por favor, faça login novamente.',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        window.location.href = 'login.html';
                    });
                    return;
                }

                const url = `${API_URL}/painel-admin?data_inicial=${dataInicial}&data_final=${dataFinal}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Erro ao carregar dados');
                }

                const dados = await response.json();

                const numero_agendamentos = dados.numero_clientes_agendou || 0;
                const faturamento = dados.faturamento_total || 0;
                const quantidade_clientes = dados.quantidade_clientes || 0;

                document.getElementById('numAgendamentos').textContent = numero_agendamentos;
                document.getElementById('faturamento').textContent = `R$ ${faturamento.toFixed(2).replace('.', ',')}`;
                document.getElementById('qtdClientes').textContent = quantidade_clientes;

            } catch (error) {
                document.getElementById('numAgendamentos').textContent = '0';
                document.getElementById('faturamento').textContent = 'R$ 0,00';
                document.getElementById('qtdClientes').textContent = '0';
            }
        }

        async function gerarRelatorio(tipo, dataInicial, dataFinal) {
            try {
                const token = getToken();

                if (!token) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sessão expirada',
                        text: 'Por favor, faça login novamente.'
                    }).then(() => {
                        window.location.href = 'login.html';
                    });
                    return;
                }

                let endpoint;
                switch (tipo) {
                    case 'agendamentos':
                        endpoint = '/relatorio-agendamentos';
                        break;
                    case 'faturamento':
                        endpoint = '/relatorio-faturamento';
                        break;
                    case 'clientes':
                        endpoint = '/relatorio-clientes';
                        break;
                    default:
                        return;
                }

                const url = `${API_URL}${endpoint}?data_inicial=${dataInicial}&data_final=${dataFinal}`;

                Swal.fire({
                    title: 'Gerando relatório...',
                    text: 'Por favor, aguarde',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Erro ao gerar relatório');
                }

                const blob = await response.blob();
                const urlBlob = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = urlBlob;
                a.download = `relatorio_${tipo}_${dataInicial}_a_${dataFinal}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(urlBlob);

                Swal.close();

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: 'Erro ao gerar relatório.'
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            setDataHoje();

            const hoje = new Date().toISOString().split('T')[0];
            carregarDadosPainel(hoje, hoje);

            const form = document.getElementById('filtroForm');
            if (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const dataInicial = document.getElementById('dataInicial').value;
                    const dataFinal = document.getElementById('dataFinal').value;

                    carregarDadosPainel(dataInicial, dataFinal);
                });
            }

            document.querySelectorAll('.botao-relatorio').forEach(botao => {
                botao.addEventListener('click', function (e) {
                    e.preventDefault();

                    const tipo = this.getAttribute('data-tipo');
                    const dataInicial = document.getElementById('dataInicial').value;
                    const dataFinal = document.getElementById('dataFinal').value;

                    gerarRelatorio(tipo, dataInicial, dataFinal);
                });
            });

            const logoutBtn = document.querySelector('.btn-logout');

            if (logoutBtn) {
                logoutBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    Swal.fire({
                        title: 'Deseja realmente sair?',
                        text: 'Você precisará fazer login novamente.',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'SIM',
                        cancelButtonText: 'NÃO',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            localStorage.removeItem('token');
                            sessionStorage.removeItem('token');
                            document.cookie = 'session=; Max-Age=0; path=/;';

                            Swal.fire({
                                icon: 'success',
                                title: 'Desconectado',
                                showConfirmButton: false,
                                timer: 1200
                            }).then(() => {
                                window.location.href = 'login.html';
                            });
                        }
                    });
                });
            }
        });
    </script>

</body>

</html>