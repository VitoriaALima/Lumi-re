<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumiére - Cadastro de serviços</title>
    <link rel="stylesheet" href="assets/css/index.cadastroservico.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@1,700&display=swap"
        rel="stylesheet">
</head>

<body>
    <header>
        <img src="assets/img/logo.png" alt="LUMIÉRE - Beleza | Estética | Bem-estar" class="logo">
        <nav>
            <a class="btn-logout" style="cursor: pointer;">LOGOUT</a>
            <a href="edicao_dados.html">EDIÇÃO DE DADOS</a>
            <a href="cadastroservico.html">CADASTRAR SERVIÇOS</a>
            <a href="index.cadastroservico.html">CADASTRAR AGENDAMENTO</a>
            <a href="painel_profissional.html">PAINEL PROFISSIONAL</a>
            <a href="painel_administrativo.html">PAINEL ADMINISTRATIVO</a>
            <a href="listagem.html">LISTAGEM</a>
        </nav>
    </header>

    <section class="cadastro-container">
        <div class="decorative-line">
            <h1><span style="color:#fff;">Sucesso!</span></h1>
            <p class="subtitulo">Realize aqui o cadastro de seus serviços</p>
        </div>

        <form class="form-cadastro">
            <div class="form-group">
                <label for="descricao">DESCRIÇÃO</label>
                <input type="text" id="descricao" required>
            </div>
            <div class="form-group">
                <label for="valor">VALOR</label>
                <input type="number" id="valor" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="duracao_horas">DURAÇÃO</label>
                <input type="time" id="duracao_horas" required>
            </div>
            <div class="form-group">
                <label for="categoria">CATEGORIA</label>
                <select id="categoria" class="selecionar" required>
                    <option value="">Selecione seu tipo ></option>
                    <option value="Cabelereiro(a)">Cabelereiro(a)</option>
                    <option value="Manicure e pedicure">Manicure e pedicure</option>
                    <option value="Maquiador(a)">Maquiador(a)</option>
                    <option value="Designer de sobrancelhas">Designer de sobrancelhas</option>
                </select>
            </div>

            <div class="form-actions">
                <p class="aviso">*Verifique se todos os dados foram informados corretamente antes de enviar.</p>
                <button type="submit" class="btn-enviar">ENVIAR</button>
            </div>
        </form>
    </section>

    <footer class="footer">
        <div class="footer1">
            <div class="footer-left">
                <div class="contact">
                    <img src="assets/img/celular.icon.png" alt="Telefone" class="icon">
                    <span>(18)000000000</span>
                </div>
                <div class="contact">
                    <img src="assets/img/location-icon.png" alt="Localização" class="icon">
                    <span>Avenida das flores</span>
                </div>
            </div>
            <div class="footer-center">
                <img src="assets/img/logo.png" alt="Logo Lumiére" class="logo">
            </div>
        </div>
        <div class="footer-bottom">
            <span>© 2025. Todos os direitos reservados.</span>
        </div>
    </footer>

    <script>
        const API_URL = 'http://10.92.3.171:5000';

        function getToken() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            console.log('Token encontrado:', token ? 'Sim' : 'Não');
            console.log('Token value:', token);
            return token;
        }

        function verificarAutenticacao() {
            const token = getToken();
            if (!token) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Acesso negado',
                    text: 'Você precisa estar logado para acessar esta página.',
                    confirmButtonText: 'Ir para Login',
                    allowOutsideClick: false
                }).then(() => {
                    window.location.href = 'login.html';
                });
                return false;
            }
            return true;
        }

        window.addEventListener('load', function () {
            verificarAutenticacao();
        });

        document.querySelector(".form-cadastro").addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!verificarAutenticacao()) return;

            const token = getToken();

            const descricao = document.getElementById("descricao").value.trim();
            const valor = parseFloat(document.getElementById("valor").value);
            const duracao_horas = document.getElementById("duracao_horas").value;
            const categoria = document.getElementById("categoria").value;

            // Validação completa
            if (!descricao || !valor || !duracao_horas || !categoria) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atenção',
                    text: 'Preencha todos os campos obrigatórios!'
                });
                return;
            }

            // Validação do valor
            if (valor <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atenção',
                    text: 'O valor deve ser maior que zero!'
                });
                return;
            }

            // Validação da duração 
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timeRegex.test(duracao_horas)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Atenção',
                    text: 'Formato de duração inválido! Use HH:MM (ex: 01:30)'
                });
                return;
            }

            const dados = {
                descricao: descricao,
                valor: valor,
                duracao_horas: duracao_horas
                // categoria não é enviada porque não está na tabela SERVICO
                // ela serve apenas para contexto no frontend
            };

            Swal.fire({
                title: 'Cadastrando...',
                text: 'Aguarde',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                console.log('Enviando requisição para:', `${API_URL}/servico`);
                console.log('Token sendo enviado:', token);
                console.log('Dados sendo enviados:', dados);

                const response = await fetch(`${API_URL}/servico`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

                let result;
                const contentType = response.headers.get("content-type");

                if (contentType && contentType.includes("application/json")) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    result = { error: text };
                }

                if (response.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "Sucesso!",
                        text: result.message || "Serviço cadastrado com sucesso!"
                    }).then(() => {
                        document.querySelector(".form-cadastro").reset();
                    });
                } else if (response.status === 401) {
                    localStorage.removeItem('token');
                    sessionStorage.removeItem('token');
                    Swal.fire({
                        icon: "warning",
                        title: "Sessão expirada",
                        text: "Faça login novamente.",
                        allowOutsideClick: false
                    }).then(() => {
                        window.location.href = 'login.html';
                    });
                } else if (response.status === 403) {
                    Swal.fire({
                        icon: "error",
                        title: "Acesso negado",
                        text: result.error || "Você não tem permissão para cadastrar serviços."
                    });
                } else if (response.status === 400) {
                    Swal.fire({
                        icon: "error",
                        title: "Erro de validação",
                        text: result.error || "Verifique os dados informados."
                    });
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Erro",
                        text: result.error || "Erro ao cadastrar serviço!"
                    });
                }
            } catch (err) {
                console.error('Erro ao cadastrar serviço:', err);
                Swal.fire({
                    icon: "error",
                    title: "Erro de conexão",
                    text: "Verifique se o servidor está rodando e se a URL está correta."
                });
            }
        });

        const logoutBtn = document.querySelector('.btn-logout');

        if (logoutBtn) {
            logoutBtn.addEventListener('click', function (e) {
                e.preventDefault();

                Swal.fire({
                    title: 'Deseja realmente sair?',
                    text: 'Você precisará fazer login novamente.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'SIM',
                    cancelButtonText: 'NÃO',
                    reverseButtons: true
                }).then((result) => {

                    // evita processar logout quando o usuário cancelar
                    if (!result.isConfirmed) return;

                    try {
                        // garante que nenhum token após o logout
                        localStorage.removeItem('token');
                        sessionStorage.removeItem('token');
                        document.cookie = 'session=; Max-Age=0; path=/;';

                        Swal.fire({
                            icon: 'success',
                            title: 'Desconectado',
                            text: 'Você será redirecionado...',
                            showConfirmButton: false,
                            timer: 1200
                        }).then(() => {

                            try {
                                // redirecionamento isolado para capturar falhas de navegador
                                window.location.href = 'login.html';

                            } catch (redirectErr) {
                                console.error('Erro ao redirecionar:', redirectErr);

                                Swal.fire({
                                    icon: 'error',
                                    title: 'Erro ao redirecionar',
                                    text: 'Não foi possível ir para a tela de login.'
                                });
                            }

                        });

                    } catch (err) {
                        console.error('Erro ao efetuar logout:', err);

                        // garante fallback caso algo impeça a limpeza do estado
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro ao sair',
                            text: 'Não foi possível completar o logout. Tente novamente.'
                        });
                    }
                });
            });
        }
    </script>
</body>

</html>