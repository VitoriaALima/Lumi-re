<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumiére - HOME</title>
    <link rel="stylesheet" href="assets/css/HOME_cliente.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@1,700&display=swap" rel="stylesheet">

    <script src="assets/js/seguranca.js" defer></script>
</head>

<body>

    <header>
        <img src="assets/img/logo.png" alt="LUMIÉRE - Beleza | Estética | Bem-estar" class="logo">
        <nav>
            <a href="editar_perfil.html">PERFIL</a>
            <a href="lembretes.html">LEMBRETES</a>
            <a href="HOME_cliente.html">HOME</a>
            <a class="btn-logout" style="cursor: pointer;">LOGOUT</a>
        </nav>
    </header>

    <section class="agendamento-container">
        <h1>Bem-vindo(a) <span id="nome-usuario">Nome!</span></h1>

        <div class="selecionar-container">
            <div class="campo">
                <label for="servico">Selecione o serviço que deseja obter:</label>
                <select id="servico">
                    <option>Selecione o serviço</option>
                </select>
            </div>

            <div class="campo">
                <label for="profissional">Selecione o profissional que deseja:</label>
                <select id="profissional">
                    <option>Selecione o profissional</option>
                </select>
            </div>
        </div>

        <h2>HORÁRIOS DISPONÍVEIS</h2>

        <form class="horarios" id="formHorarios"></form>
    </section>

    <footer class="footer">
        <div class="footer1">
            <div class="footer-left">
                <div class="contact">
                    <img src="assets/img/celular.icon.png" alt="Telefone" class="icon">
                    <span>(18)000000000</span>
                </div>
                <div class="contact">
                    <img src="assets/img/location-icon.png" alt="Localização" class="icon">
                    <span>Avenida das flores</span>
                </div>
            </div>

            <div class="footer-center">
                <img src="assets/img/logo.png" alt="Logo Lumiére" class="logorodape">
            </div>
        </div>

        <div class="footer-bottom">
            <span>© 2025. Todos os direitos reservados.</span>
        </div>
    </footer>

    <script>
        
           //MOSTRAR PRIMEIRO NOME DO USUÁRIO
        
        document.addEventListener("DOMContentLoaded", () => {
            const nomeCompleto = localStorage.getItem("nome");
            const nomeSpan = document.getElementById("nome-usuario");

            if (nomeCompleto && nomeSpan) {
                const primeiroNome = nomeCompleto.split(" ")[0];
                nomeSpan.textContent = primeiroNome;
            }
        });

        const API_URL = "http://10.92.3.171:5000";

        function getToken() {
            return localStorage.getItem("token") || sessionStorage.getItem("token");
        }

        document.addEventListener("DOMContentLoaded", () => {
            carregarServicos();
            configurarEventos();
        });

      
          // LOGOUT
        
        document.querySelector(".btn-logout").addEventListener("click", function (e) {
            e.preventDefault();

            Swal.fire({
                title: "Deseja realmente sair?",
                text: "Você precisará fazer login novamente.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "SIM",
                cancelButtonText: "NÃO",
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem("token");
                    localStorage.removeItem("usuarioId");
                    Swal.fire({
                        icon: "success",
                        title: "Desconectado",
                        timer: 1200,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "login.html";
                    });
                }
            });
        });

        
            //CARREGAR SERVIÇOS
        
        async function carregarServicos() {
            try {
                const response = await fetch(`${API_URL}/servico`);
                const servicos = await response.json();

                const select = document.getElementById("servico");
                servicos.forEach(s => {
                    select.innerHTML += `<option value="${s.id_servico}">${s.descricao}</option>`;
                });

            } catch (e) {
                console.error(e);
                alert("Erro ao carregar serviços.");
            }
        }

        function configurarEventos() {
            document.getElementById("servico").addEventListener("change", async function () {
                const id_servico = this.value;
                if (!id_servico) return;
                await carregarProfissionais(id_servico);
            });

            document.getElementById("profissional").addEventListener("change", function () {
                const id_profissional = this.value;
                const id_servico = document.getElementById("servico").value;
                if (!id_profissional || !id_servico) return;
                carregarHorarios(id_profissional, id_servico);
            });
        }

        
          // CARREGAR PROFISSIONAIS DO SERVIÇO
        
        async function carregarProfissionais(id_servico) {
            try {
                const response = await fetch(`${API_URL}/profissionais-por-servico?id_servico=${id_servico}`);
                const profissionais = await response.json();

                const select = document.getElementById("profissional");
                select.innerHTML = `<option value="">Selecione o profissional</option>`;

                profissionais.forEach(p => {
                    select.innerHTML += `<option value="${p.id_profissional}">${p.nome}</option>`;
                });

            } catch (e) {
                console.error(e);
                alert("Erro ao carregar profissionais.");
            }
        }

        
         //  CARREGAR HORÁRIOS DISPONÍVEIS
       
        async function carregarHorarios(id_profissional, id_servico) {

            try {
                const response = await fetch(
                    `${API_URL}/horarios-disponiveis?id_profissional=${id_profissional}&id_servico=${id_servico}`
                );

                const horarios = await response.json();
                const form = document.getElementById("formHorarios");
                form.innerHTML = "";

                if (horarios.length === 0) {
                    form.innerHTML = "<p>Nenhum horário disponível.</p>";
                    return;
                }

                horarios.forEach(h => {
                    form.innerHTML += `
                        <label class="opcao">
                            <input type="radio" name="horario" value="${h.data_hora}">
                            <span>${h.hora_formatada} - ${h.data_formatada}</span>
                        </label>
                    `;
                });

                form.innerHTML += `<button type="submit" class="btn-agendar">AGENDAR</button>`;

            } catch (e) {
                console.error(e);
                alert("Erro ao carregar horários.");
            }
        }

        
          // ENVIAR AGENDAMENTO + RECARREGAR HORÁRIOS
        
        document.getElementById("formHorarios").addEventListener("submit", async function (e) {
            e.preventDefault();

            const radio = document.querySelector("input[name='horario']:checked");
            if (!radio) {
                Swal.fire({ icon: "warning", title: "Selecione um horário!" });
                return;
            }

            const token = getToken();
            if (!token) {
                Swal.fire({ icon: "error", title: "Faça login novamente" });
                return;
            }

            const data_hora = radio.value;
            const id_servico = document.getElementById("servico").value;
            const id_profissional = document.getElementById("profissional").value;

            const payload = { id_profissional, id_servico, data_hora };

            try {
                const response = await fetch(`${API_URL}/agenda/criar`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    Swal.fire({ icon: "error", title: "Erro", text: result.error || "Falha ao agendar." });
                    return;
                }

                Swal.fire({
                    icon: "success",
                    title: "Agendado com sucesso!",
                    timer: 1500,
                    showConfirmButton: false
                });

                setTimeout(() => {
                    carregarHorarios(id_profissional, id_servico);
                }, 1200);

            } catch (e) {
                console.error(e);
                Swal.fire({
                    icon: "error",
                    title: "Erro",
                    text: "Não foi possível criar o agendamento."
                });
            }
        });

    </script>

</body>
</html>
