<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumiére - HOME</title>
    <link rel="stylesheet" href="assets/css/HOME_cliente.css">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:ital,wght@1,700&display=swap"
        rel="stylesheet">

    <!-- SweetAlert para alertas bonitos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <section class="agendamento-container">
        <h1>Bem-vindo(a)<br><span class="nome">Nome!</span></h1>

        <div class="selecionar-container">
            <div class="campo">
                <label for="servico">Selecione o serviço que deseja obter:</label>
                <select id="servico">
                    <option>Selecione o serviço</option>
                </select>
            </div>

            <div class="campo">
                <label for="profissional">Selecione o profissional que deseja:</label>
                <select id="profissional">
                    <option>Selecione o profissional</option>
                </select>
            </div>
        </div>

        <h2>HORÁRIOS DISPONÍVEIS</h2>

        <form class="horarios" id="formHorarios">
            <!-- Horários serão adicionados via JavaScript -->
        </form>
    </section>

    <script>

        // CONFIGURAÇÕES INICIAIS


        const API_URL = "http://10.92.3.96:5000"; // <-- Altere para o IP do seu backend Flask

        // Função para obter o token salvo no navegador
        function getToken() {
            return localStorage.getItem("token") || sessionStorage.getItem("token");
        }

        // Função para exibir o nome do usuário
        function mostrarNomeUsuario() {
            const nomeUsuario = localStorage.getItem("nomeUsuario"); // salvo no login
            const nomeSpan = document.querySelector(".nome");
            if (nomeUsuario) {
                nomeSpan.textContent = nomeUsuario + "!";
            } else {
                nomeSpan.textContent = "Cliente!";
            }
        }


        // FUNÇÃO PARA BUSCAR AGENDAMENTOS DO CLIENTE

        async function carregarAgendamentos() {
            const token = getToken();

            if (!token) {
                Swal.fire({
                    icon: "warning",
                    title: "Sessão expirada",
                    text: "Por favor, faça login novamente."
                }).then(() => window.location.href = "login.html");
                return;
            }

            try {
                // Faz a requisição GET à rota Flask
                const response = await fetch(`${API_URL}/agenda/meus-agendamentos`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    Swal.fire({
                        icon: "error",
                        title: "Sessão expirada",
                        text: "Faça login novamente."
                    }).then(() => window.location.href = "login.html");
                    return;
                }

                if (!response.ok) {
                    throw new Error("Erro ao buscar agendamentos");
                }

                // Converte o resultado para JSON
                const agendamentos = await response.json();

                // Chama a função que vai exibir os horários
                exibirHorarios(agendamentos);

            } catch (error) {
                console.error(error);
                Swal.fire({
                    icon: "error",
                    title: "Erro de conexão",
                    text: "Não foi possível carregar seus agendamentos."
                });
            }
        }


        // FUNÇÃO PARA EXIBIR HORÁRIOS NA TELA

        function exibirHorarios(agendamentos) {
            const form = document.getElementById("formHorarios");
            form.innerHTML = ""; // limpa conteúdo anterior

            if (agendamentos.length === 0) {
                form.innerHTML = "<p>Nenhum agendamento encontrado.</p>";
                return;
            }

            // Para cada agendamento recebido, cria um radio button
            agendamentos.forEach(ag => {
                const dataHora = new Date(ag.data_hora).toLocaleString("pt-BR", {
                    day: "2-digit", month: "2-digit", year: "numeric",
                    hour: "2-digit", minute: "2-digit"
                });

                const label = document.createElement("label");
                label.classList.add("opcao");

                label.innerHTML = `
                    <input type="radio" name="horario" value="${ag.id_agenda}">
                    <span>${dataHora} - ${ag.servico} (${ag.profissional})</span>
                `;

                form.appendChild(label);
            });

            // Botão de ação
            const btn = document.createElement("button");
            btn.type = "submit";
            btn.classList.add("btn-agendar");
            btn.textContent = "AGENDAR";
            form.appendChild(btn);
        }

       
        // EVENTO PRINCIPAL AO CARREGAR PÁGINA
       
        document.addEventListener("DOMContentLoaded", () => {
            mostrarNomeUsuario();
            carregarAgendamentos();

            // Apenas exemplo de evento de submit
            document.getElementById("formHorarios").addEventListener("submit", (e) => {
                e.preventDefault();

                const selecionado = document.querySelector("input[name='horario']:checked");
                if (!selecionado) {
                    Swal.fire({
                        icon: "warning",
                        title: "Selecione um horário antes de agendar!"
                    });
                    return;
                }

                Swal.fire({
                    icon: "success",
                    title: "Agendamento realizado com sucesso!",
                    showConfirmButton: false,
                    timer: 1500
                });
            });
        });
    </script>
</body>

</html>